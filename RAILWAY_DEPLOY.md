# Railway Deployment Guide - solarLEADmax

This guide covers deploying the solarLEADmax backend to Railway with three environments: Development (A), Staging (B), and Production (C).

## Prerequisites

### Required
- Railway account ([railway.app](https://railway.app))
- GitHub repository with solarLEADmax code (already done ✅)
- Vercel account (for frontend deployment)

### Optional (for full production mode)
- Twilio account with SMS-capable phone number
- OpenAI API key
- Calendly API access token

**Note:** You can deploy in DEMO_MODE without external services!

## Step 1: Create Railway Project

1. Log in to Railway
2. Click "New Project" → "Deploy from GitHub repo"
3. Select your `solarLEADmax` repository
4. Name the project: `solarLEADmax`

## Step 2: Set Up Three Environments

Railway environments allow you to run dev, staging, and prod with different configurations.

### Create Environments

1. In Railway project, go to Settings → Environments
2. Create three environments:
   - **A (Development)** - for testing
   - **B (Staging)** - pre-production
   - **C (Production)** - live system

## Step 3: Add Database & Redis (Per Environment)

For **each environment** (A, B, C):

1. Click "+ New" → "Database" → "Add PostgreSQL"
   - This creates a `DATABASE_URL` variable automatically
2. Click "+ New" → "Database" → "Add Redis"
   - This creates a `REDIS_URL` variable automatically

## Step 4: Create Two Services (API & Worker)

### API Service

1. Click "+ New" → "GitHub Repo" → Select `solarLEADmax`
2. Name: `api`
3. Go to Settings:
   - **Builder**: Dockerfile
   - **Dockerfile Path**: `backend/Dockerfile`
   - **Start Command**: `npx prisma migrate deploy && node dist/index.js`
   - **Healthcheck Path**: `/api/health`
4. Set environment variables (see below)

### Worker Service

1. Click "+ New" → "GitHub Repo" → Select `solarLEADmax`
2. Name: `worker`
3. Go to Settings:
   - **Builder**: Dockerfile
   - **Dockerfile Path**: `backend/Dockerfile`
   - **Start Command**: `node dist/worker/index.js`
4. Set environment variables (same as API, minus PORT)

## Step 5: Environment Variables

For **both API and Worker** services in **each environment**, set these variables:

### Required Variables

```env
# Node
NODE_ENV=production
PORT=3000  # API only

# Demo Mode (set to true to skip external API calls)
DEMO_MODE=false  # Set to true for demo without Twilio/OpenAI

# Database (auto-generated by Railway PostgreSQL plugin)
DATABASE_URL=${{Postgres.DATABASE_URL}}

# Redis (auto-generated by Railway Redis plugin)
REDIS_URL=${{Redis.REDIS_URL}}

# OpenAI (optional if DEMO_MODE=true)
OPENAI_API_KEY=sk-...  # Leave empty for demo mode

# Twilio (optional if DEMO_MODE=true)
TWILIO_ACCOUNT_SID=AC...  # Leave empty for demo mode
TWILIO_AUTH_TOKEN=...  # Leave empty for demo mode
TWILIO_PHONE_NUMBER=+1...  # Leave empty for demo mode

# Calendly (optional if DEMO_MODE=true)
CALENDLY_API_KEY=...  # Leave empty for demo mode
CALENDLY_EVENT_TYPE_UUID=...  # Leave empty for demo mode

# CORS (adjust per environment)
# Dev (A):
CORS_ORIGIN=http://localhost:5173,https://your-dev-frontend.vercel.app
# Staging (B):
CORS_ORIGIN=https://your-staging-frontend.vercel.app
# Production (C):
CORS_ORIGIN=https://your-prod-frontend.vercel.app

# JWT Secret (generate unique for each environment)
JWT_SECRET=your_random_secret_here

# Optional (Phase 3+)
MAILGUN_API_KEY=
MAILGUN_DOMAIN=
EMAIL_FROM=solai@yourdomain.com
GOOGLE_MAPS_API_KEY=

# Optional (for voice calling)
PUBLIC_API_BASE_URL=${{API.RAILWAY_PUBLIC_DOMAIN}}
```

### Railway Variable References

Railway allows you to reference other services:
- `${{Postgres.DATABASE_URL}}` - references PostgreSQL plugin
- `${{Redis.REDIS_URL}}` - references Redis plugin
- `${{API.RAILWAY_PUBLIC_DOMAIN}}` - references API service domain

## Step 6: Deploy

1. Railway will auto-deploy on push to `main` branch
2. Monitor deployment logs in Railway dashboard
3. Wait for both API and Worker services to show "Active"
4. Check API health: `https://your-api-domain.railway.app/api/health`

## Step 7: Configure Webhooks

### Twilio Webhook (SMS)

1. Go to Twilio Console → Phone Numbers → Your Number
2. Under "Messaging", set:
   - **Webhook URL**: `https://your-api-domain.railway.app/api/webhooks/twilio`
   - **HTTP Method**: POST
3. Save

### Twilio Webhook (Voice) - Optional for Phase 3

1. Under "Voice & Fax":
   - **Webhook URL**: `https://your-api-domain.railway.app/api/webhooks/twilio/voice`
   - **HTTP Method**: GET or POST

### Twilio Status Callback

1. Under "Messaging":
   - **Status Callback URL**: `https://your-api-domain.railway.app/api/webhooks/twilio/status`

### Calendly Webhook

1. Go to Calendly API Webhooks: https://calendly.com/integrations/api_webhooks
2. Create webhook subscription:
```bash
curl -X POST https://api.calendly.com/webhook_subscriptions \
  -H "Authorization: Bearer YOUR_CALENDLY_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://your-api-domain.railway.app/api/webhooks/calendly",
    "events": ["invitee.created", "invitee.canceled"],
    "organization": "https://api.calendly.com/organizations/YOUR_ORG_UUID",
    "scope": "organization"
  }'
```

## Step 8: Test End-to-End

### Test Lead Intake

```bash
curl -X POST https://your-api-domain.railway.app/api/leads/intake \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test User",
    "phone": "+15555551234",
    "email": "test@example.com",
    "address": "123 Main St, Phoenix, AZ",
    "source": "website",
    "monthly_bill": 200
  }'
```

Expected: 
- 201 response with `lead_id`
- Lead stored in PostgreSQL
- Initial contact SMS sent via Twilio
- Worker logs show job processing

### Test Inbound SMS

1. Reply to the SMS from your test lead's phone
2. Check Railway logs for:
   - Webhook received
   - Conversation stored
   - AI processing job enqueued
3. Check database: `Conversation` record created with `ai_processed: false`

## Step 9: Environment-Specific Configuration

### Development (A)

- Use Twilio Test Credentials (optional)
- Lower rate limits (100 req/15min is fine)
- Verbose logging
- No cost concerns

### Staging (B)

- Use production Twilio but test phone numbers
- Same database schema as production
- Run integration tests here
- Mirror production config

### Production (C)

- Real Twilio numbers
- Stricter rate limits if needed
- Monitor costs (OpenAI, Twilio)
- Enable Sentry error tracking (Phase 2)
- Set up alerts for downtime

## Step 10: Continuous Deployment

Railway automatically deploys when you push to `main`. To deploy specific environments:

1. Go to Railway project → Environment
2. Switch to desired environment (A, B, or C)
3. Click "Redeploy" on API and Worker services

### Branch Strategy (Optional)

- `main` → Production (C)
- `staging` → Staging (B)
- `dev` → Development (A)

Configure branch-to-environment mapping in Railway Settings.

## Troubleshooting

### API Won't Start

- Check `DATABASE_URL` is set and valid
- Verify Prisma migrations ran: `npx prisma migrate deploy`
- Check logs for TypeScript errors or missing env vars

### Worker Won't Process Jobs

- Verify `REDIS_URL` is correct
- Check Redis connection in worker logs
- Ensure both API and Worker share same Redis instance

### SMS Not Sending

- Verify `TWILIO_ACCOUNT_SID`, `TWILIO_AUTH_TOKEN`, `TWILIO_PHONE_NUMBER`
- Check Twilio Console for error logs
- Ensure phone number is SMS-enabled

### Webhooks Not Receiving

- Verify webhook URLs use HTTPS Railway domains
- Check Twilio webhook logs for 4xx/5xx errors
- Test webhook locally with ngrok first

### Database Migration Fails

- Manually run: `railway run npx prisma migrate deploy`
- Check PostgreSQL logs in Railway
- Ensure `DATABASE_URL` includes `?schema=public`

## Monitoring

### Railway Logs

- View realtime logs in Railway dashboard
- Filter by service (api/worker)
- Search for errors with "error" keyword

### Health Checks

- Railway pings `/api/health` every 30 seconds
- If health check fails 3 times, service restarts
- Monitor restart count in Metrics tab

### Database Queries

Use Railway PostgreSQL plugin to run queries:

```sql
-- Lead stats
SELECT status, COUNT(*) FROM "Lead" GROUP BY status;

-- Recent conversations
SELECT * FROM "Conversation" ORDER BY created_at DESC LIMIT 10;

-- Appointments
SELECT * FROM "Appointment" WHERE status = 'scheduled';
```

## Cost Estimates

### Railway (per environment)

- **Hobby Plan**: $5/month (includes $5 credit)
- **PostgreSQL**: ~$0 (included in credit)
- **Redis**: ~$0 (included in credit)
- **API + Worker**: ~$10/month total

### External Services

- **Twilio SMS**: $0.0079/message
- **OpenAI GPT-4o**: ~$0.01/lead (Phase 2)
- **Mailgun**: $0.80/1000 emails (Phase 3)

**Total estimated cost for 1,000 leads/month**: ~$30-50

---

## Step 11: Deploy Frontend to Vercel

The React frontend (Vite + Tailwind) needs to be deployed separately.

### Quick Deploy

1. **Install Vercel CLI:**
   ```bash
   npm i -g vercel
   ```

2. **Deploy from frontend directory:**
   ```bash
   cd frontend
   vercel --prod
   ```

3. **Set environment variable in Vercel:**
   - Go to Vercel project → Settings → Environment Variables
   - Add: `VITE_API_BASE_URL` = `https://your-railway-api.railway.app/api`
   - Redeploy after adding env var

### Via Vercel Dashboard

1. Go to [vercel.com](https://vercel.com) and import your GitHub repo
2. Framework Preset: **Vite**
3. Root Directory: `frontend`
4. Build Command: `npm run build`
5. Output Directory: `dist`
6. Environment Variables:
   - `VITE_API_BASE_URL` = `https://your-railway-api.railway.app/api`
7. Deploy!

### Update CORS on Railway

After frontend is deployed, update your Railway API's `CORS_ORIGIN` env var:

```env
CORS_ORIGIN=https://your-frontend.vercel.app
```

Redeploy the API service.

### Test Frontend

1. Visit your Vercel URL
2. You should see the gradient Dashboard
3. Create a demo lead
4. View leads list and click into a lead to see conversation history

---

## Quick Demo Deploy (DEMO_MODE=true)

For a quick demo without external services:

1. **Railway Backend:**
   - Set `DEMO_MODE=true`
   - Only PostgreSQL and Redis required
   - Skip Twilio, OpenAI, Calendly
   - Seed database: `railway run npx tsx src/scripts/seed.ts`

2. **Vercel Frontend:**
   - Deploy with `VITE_API_BASE_URL` pointing to Railway
   - All demo endpoints (`/api/demo/onboarding`) work without external services

3. **Demo Features:**
   - Static demo page at `/demo`
   - Demo lead creation from frontend Dashboard
   - Full UI with 12 mock leads (after seeding)
   - Conversation history display

---

## Next Steps

1. Deploy Backend to Railway (Development environment)
2. Deploy Frontend to Vercel
3. Test demo mode end-to-end
4. Add Twilio/OpenAI credentials and set `DEMO_MODE=false` for production
5. Configure webhooks
6. Deploy Staging and Production environments
7. Set up monitoring and alerts
